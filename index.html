<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poems</title>

  <style>
    :root{
      --ivory:#f6f1e7;
      --paper:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:rgba(31,41,55,.12);
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --serif: ui-serif, Georgia, Garamond, "Times New Roman", serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;background:var(--ivory);color:var(--ink);font-family:var(--sans)}

    header{
      max-width:1100px;margin:0 auto;padding:24px 18px 10px;
      display:flex;justify-content:space-between;gap:16px;align-items:flex-end;
    }
    .brand h1{margin:0;font-size:22px;font-weight:700}
    .brand p{margin:6px 0 0;color:var(--muted);font-size:13px}

    .wrap{
      max-width:1100px;margin:0 auto;padding:14px 18px 40px;
      display:grid;grid-template-columns:320px 1fr;gap:18px;
    }
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}

    .card{
      background:var(--paper);border:1px solid var(--line);
      border-radius:14px;box-shadow:var(--shadow);overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .hd h2{
      margin:0;font-size:14px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.2px;font-weight:700;
    }
    .bd{padding:14px}

    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;background:#fff;
      white-space:nowrap;
    }

    /* Left */
    .search{
      width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:10px;font-size:14px;outline:none;background:#fff;
    }
    .poemList{
      margin-top:12px;display:flex;flex-direction:column;gap:8px;
      max-height:420px;overflow:auto;padding-right:4px;
    }
    .poemLink{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      text-decoration:none;
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:#fff;transition:transform .06s ease,border-color .12s ease;
      color:inherit;
    }
    .poemLink:hover{transform:translateY(-1px);border-color:rgba(31,41,55,.25)}
    .poemLink.active{border-color:rgba(31,41,55,.55)}
    .poemTitle{font-family:var(--serif);font-size:16px}
    .poemMeta{font-size:12px;color:var(--muted)}

    .about{margin-top:12px;color:var(--muted);font-size:14px;line-height:1.6}

    /* Right feed */
    .feed{
      max-height: calc(100vh - 150px);
      overflow:auto;
      padding: 14px;
    }
    @media (max-width:900px){
      .feed{max-height:none;overflow:visible;padding:14px}
    }
    .poemCard{
      background:#fff;border:1px solid var(--line);border-radius:14px;
      box-shadow: var(--shadow);
      padding: 18px;
      margin-bottom: 14px;
    }
    .poemCard:last-child{margin-bottom:0}
    .poemCard h3{
      margin:0;
      font-family:var(--serif);
      font-size:28px;
      letter-spacing:.2px;
    }
    .poemDate{margin:8px 0 0;color:var(--muted);font-size:13px}
    .poemBody{
      margin-top:16px;
      font-family:var(--serif);
      font-size:19px;
      line-height:1.75;
      white-space:pre-wrap;
    }
    .hidden{display:none !important;}

    /* highlight when jumped to */
    .flash{
      outline: 2px solid rgba(31,41,55,.35);
      outline-offset: 3px;
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <h1 id="siteTitle">Poems</h1>
      <p id="tagline">A small room for words.</p>
    </div>
    <div class="pill" id="statusPill">Loading…</div>
  </header>

  <main class="wrap">
    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <h2>Library</h2>
        <span class="pill" id="countPill"></span>
      </div>
      <div class="bd">
        <input id="search" class="search" placeholder="Search titles..." />
        <div id="list" class="poemList"></div>

        <div class="about">
          <strong id="aboutTitle">About</strong><br/>
          <span id="aboutText"></span>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="hd">
        <h2>Feed</h2>
        <span class="pill">Read-only</span>
      </div>
      <div id="feed" class="feed"></div>
    </section>
  </main>

  <script>
    let LIB = { siteTitle:"Poems", tagline:"", aboutTitle:"About", aboutText:"", poems:[] };
    const statusPill = document.getElementById("statusPill");
    const countPill  = document.getElementById("countPill");

    const siteTitleEl = document.getElementById("siteTitle");
    const taglineEl   = document.getElementById("tagline");
    const aboutTitleEl= document.getElementById("aboutTitle");
    const aboutTextEl = document.getElementById("aboutText");

    const searchEl = document.getElementById("search");
    const listEl   = document.getElementById("list");
    const feedEl   = document.getElementById("feed");

    let selectedId = null;

    async function loadLibrary(){
      try{
        const res = await fetch("./poems.json", { cache: "no-store" });
        if(!res.ok) throw new Error("Could not load poems.json");
        LIB = await res.json();
        LIB.poems = Array.isArray(LIB.poems) ? LIB.poems : [];

        // Sort newest first by date
        LIB.poems.sort((a,b) => (b.date || "").localeCompare(a.date || ""));

        siteTitleEl.textContent = LIB.siteTitle || "Poems";
        taglineEl.textContent   = LIB.tagline || "";
        aboutTitleEl.textContent= LIB.aboutTitle || "About";
        aboutTextEl.textContent = LIB.aboutText || "";

        countPill.textContent = `${LIB.poems.length} poems`;
        statusPill.textContent = "Loaded";

        renderAll();
        openFromHash(); // if someone visits /#some-id
      }catch(e){
        statusPill.textContent = "Error";
        feedEl.innerHTML = `<div style="padding:14px;color:#6b7280">
          Couldn’t load <code>poems.json</code>. Make sure it’s in the repo root.
        </div>`;
        console.error(e);
      }
    }

    function renderAll(){
      renderList();
      renderFeed();
    }

    function renderList(){
      const q = (searchEl.value || "").trim().toLowerCase();
      const poems = LIB.poems.filter(p => (p.title || "").toLowerCase().includes(q));

      listEl.innerHTML = "";
      for(const p of poems){
        const a = document.createElement("a");
        a.href = `#${encodeURIComponent(p.id)}`;
        a.className = "poemLink" + (p.id === selectedId ? " active" : "");

        const left = document.createElement("div");
        left.className = "poemTitle";
        left.textContent = p.title || "(Untitled)";

        const right = document.createElement("div");
        right.className = "poemMeta";
        right.textContent = formatDate(p.date);

        a.append(left, right);
        a.addEventListener("click", (e) => {
          // Let hash update happen, then scroll/highlight
          selectedId = p.id;
          setTimeout(() => {
            scrollToPoem(p.id);
            renderList();
          }, 0);
        });

        listEl.appendChild(a);
      }
    }

    function renderFeed(){
      const q = (searchEl.value || "").trim().toLowerCase();
      feedEl.innerHTML = "";

      for(const p of LIB.poems){
        const match = !q || (p.title || "").toLowerCase().includes(q);

        const card = document.createElement("article");
        card.className = "poemCard" + (match ? "" : " hidden");
        card.id = `poem-${p.id}`;

        const h = document.createElement("h3");
        h.textContent = p.title || "(Untitled)";

        const d = document.createElement("div");
        d.className = "poemDate";
        d.textContent = p.date ? `Posted ${formatDate(p.date)}` : "";

        const body = document.createElement("div");
        body.className = "poemBody";
        body.textContent = p.body || "";

        card.append(h, d, body);
        feedEl.appendChild(card);
      }
    }

    function scrollToPoem(id){
      const el = document.getElementById(`poem-${id}`);
      if(!el) return;
      el.classList.remove("flash");
      el.scrollIntoView({ behavior: "smooth", block: "start" });
      // little highlight pulse
      setTimeout(() => {
        el.classList.add("flash");
        setTimeout(() => el.classList.remove("flash"), 900);
      }, 250);
    }

    function openFromHash(){
      const hash = decodeURIComponent((location.hash || "").replace(/^#/, ""));
      if(!hash) return;
      const exists = LIB.poems.some(p => p.id === hash);
      if(!exists) return;
      selectedId = hash;
      // if search is filtering it out, clear search so it appears
      if(searchEl.value) {
        searchEl.value = "";
        renderAll();
      }
      scrollToPoem(hash);
      renderList();
    }

    function formatDate(s){
      if(!s) return "";
      const d = new Date(s + "T00:00:00");
      if(isNaN(d.getTime())) return s;
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
    }

    searchEl.addEventListener("input", () => renderAll());
    window.addEventListener("hashchange", openFromHash);

    loadLibrary();
  </script>
</body>
</html>
